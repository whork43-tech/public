<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ­·å²ç¹³æ¬¾ - åˆ†æœŸè¨˜å¸³</title>
  <link rel="stylesheet" href="/static/style1.css?v=999">
  <style>
    /* åªè£œæ­·å²é éœ€è¦çš„æ¨£å¼ï¼Œä¸å½±éŸ¿å…¶ä»–é  */
    details { margin: 0; }
    summary { cursor: pointer; list-style: none; }
    summary::-webkit-details-marker { display: none; }

    .month-summary {
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      margin: 12px 0;
      font-weight: 800;
    }

    .day-thumb {
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #eee;
      margin: 8px 0;
    }

    .day-total { font-weight: 800; }

    .day-body { padding: 10px 12px 4px 12px; }

    .bulk-bar {
      display:flex; gap:10px; align-items:center;
      margin: 8px 0 12px 0;
    }

    .pay-item {
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 6px 0;
    }

    .pay-left { display:flex; align-items:center; gap:8px; }

    .muted2 { color:#666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š æ­·å²ç¹³æ¬¾</h1>

    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
      <div>ç›®å‰ç™»å…¥ï¼š<b>{{ user.username }}</b></div>
      <a class="btn" href="/">å›é¦–é </a>
    </div>

    {% if groups|length == 0 %}
      <div class="card">
        <p class="muted">ç›®å‰æ²’æœ‰ä»»ä½•ç¹³æ¬¾ç´€éŒ„</p>
      </div>
    {% else %}

      {#
        groups: [{date:'YYYY-MM-DD', total:..., payments:[{id,name,amount,period_no?...}]}]
        é€™è£¡ç”¨ date[:7] åšæœˆä»½åˆ†çµ„
      #}

      {% set ns = namespace(month=None, open_month=False) %}

      {% for g in groups %}
        {% set m = g.date[:7] %}

        {% if ns.month != m %}
          {# é—œé–‰ä¸Šä¸€å€‹æœˆä»½å®¹å™¨ #}
          {% if ns.open_month %}
              </div>
            </details>
          {% endif %}

          {% set ns.month = m %}
          {% set ns.open_month = True %}

          <details open>
            <summary class="month-summary">
              <span>ğŸ“… {{ m }}</span>
              <span class="muted2">é»æˆ‘å±•é–‹/æ”¶åˆ</span>
            </summary>
            <div style="margin: 10px 0 18px 0;">
        {% endif %}

        {# æ¯ä¸€å¤©ï¼šç¸®åœ– -> é»é–‹æ‰çœ‹åˆ°å…§å®¹ #}
        <details>
          <summary class="day-thumb">
            <span><b>{{ g.date }}</b></span>
            <span class="day-total">ç¸½æ”¶ï¼š{{ g.total }}</span>
          </summary>

          <div class="card day-body">
            <form method="post" action="/history/delete-multiple" onsubmit="return confirmHistoryBulk('{{ g.date }}');" style="margin:0;">
              <div class="bulk-bar">
                <label style="display:flex; align-items:center; gap:6px;">
                  <input type="checkbox" onclick="toggleSelectAllDay('{{ g.date|replace('-', '') }}', this)"> å…¨é¸
                </label>
                <button class="btn danger" type="submit">åˆªé™¤å‹¾é¸</button>
              </div>

              <div id="day-{{ g.date|replace('-', '') }}">
                {% for it in g.payments %}
                  <div class="pay-item">
                    <div class="pay-left">
                      <input type="checkbox" name="payment_ids" value="{{ it.id }}">
                      <span>âœ… {{ it.name }}{% if it.period_no %}ï¼šç¬¬ {{ it.period_no }} æœŸ{% endif %}ï½œ{{ it.amount }}</span>
                    </div></div>
                {% endfor %}
              </div>
            </form>
          </div>
        </details>

        {# è¿´åœˆçµæŸè¦æ”¶å°¾æœ€å¾Œä¸€å€‹æœˆä»½å®¹å™¨ #}
        {% if loop.last and ns.open_month %}
            </div>
          </details>
        {% endif %}

      {% endfor %}

    {% endif %}
  </div>

  <script>
    function toggleSelectAllDay(dayKey, master) {
      const box = document.getElementById('day-' + dayKey);
      if (!box) return;
      box.querySelectorAll('input[name="payment_ids"]').forEach(cb => cb.checked = master.checked);
    }

    function confirmHistoryBulk(dateStr) {
      const dayKey = dateStr.replaceAll('-', '');
      const box = document.getElementById('day-' + dayKey);
      if (!box) {
        alert('æ‰¾ä¸åˆ°è©²æ—¥æœŸçš„é …ç›®');
        return false;
      }
      const checked = box.querySelectorAll('input[name="payment_ids"]:checked').length;
      if (checked === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„ç¹³æ¬¾ç´€éŒ„');
        return false;
      }
      return confirm(`ç¢ºå®šè¦åˆªé™¤ ${checked} ç­†ï¼ˆ${dateStr}ï¼‰çš„ç¹³æ¬¾ç´€éŒ„å—ï¼Ÿ`);
    }
  </script>
</body>
</html>
