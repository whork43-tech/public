<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ­·å²ç¹³æ¬¾ - åˆ†æœŸè¨˜å¸³</title>
  <link rel="stylesheet" href="/static/style1.css?v=999">

  <style>
    /* ===== åªè£œæ­·å²é éœ€è¦çš„æ¨£å¼ï¼Œä¸å½±éŸ¿å…¶ä»–é  ===== */
    details {
      margin: 0;
    }

    summary {
      cursor: pointer;
      list-style: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .month-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
      margin: 12px 0;
      font-weight: 800;
      gap: 10px;
      flex-wrap: wrap;
    }

    .month-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 13px;
      opacity: .8;
      font-weight: 700;
    }

    .day-thumb {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #eee;
      margin: 8px 0;
      gap: 10px;
      flex-wrap: wrap;
    }

    .day-total {
      font-weight: 800;
    }

    .day-body {
      padding: 10px 12px 4px 12px;
    }

    .bulk-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0 12px 0;
      flex-wrap: wrap;
    }

    .pay-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      flex-wrap: wrap;
    }

    .pay-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .muted2 {
      color: #666;
      font-size: 14px;
    }

    /* å·¥å…·åˆ— */
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0 14px 0;
    }

    .toolbar input[type="text"] {
      flex: 1;
      min-width: 220px;
      padding: 9px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      outline: none;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: #fff;
      font-size: 13px;
      user-select: none;
    }

    .tiny {
      font-size: 12px;
      opacity: .75;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“Š æ­·å²ç¹³æ¬¾</h1>

    <div class="card"
      style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
      <div>ç›®å‰ç™»å…¥ï¼š<b>{{ user.username }}</b></div>
      <a class="btn" href="/">å›é¦–é </a>
    </div>

    {% if groups|length == 0 %}
    <div class="card">
      <p class="muted">ç›®å‰æ²’æœ‰ä»»ä½•ç¹³æ¬¾ç´€éŒ„</p>
    </div>
    {% else %}

    <!-- å·¥å…·åˆ— -->
    <div class="card">
      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="æœå°‹ï¼šè¼¸å…¥ æ—¥æœŸ(YYYY-MM-DD) æˆ– åç¨±ï¼ˆå³æ™‚éæ¿¾ï¼‰">

        <button type="button" class="btn" onclick="toggleAllMonths(true)">ğŸ“‚ å±•é–‹å…¨éƒ¨æœˆä»½</button>
        <button type="button" class="btn" onclick="toggleAllMonths(false)">ğŸ“ æ”¶åˆå…¨éƒ¨æœˆä»½</button>

        <button type="button" class="btn" onclick="toggleAllDays(true)">ğŸ“… å±•é–‹å…¨éƒ¨æ—¥æœŸ</button>
        <button type="button" class="btn" onclick="toggleAllDays(false)">ğŸ—“ï¸ æ”¶åˆå…¨éƒ¨æ—¥æœŸ</button>

        <span class="tiny" id="countInfo"></span>
      </div>
      <div class="tiny">
        å°æç¤ºï¼šæœå°‹åªå½±éŸ¿ç•«é¢é¡¯ç¤ºï¼Œä¸æœƒåˆªè³‡æ–™ã€‚åˆªé™¤ä»éœ€è¦ä½ å‹¾é¸ä¸¦ç¢ºèªã€‚
      </div>
    </div>

    {#
    groups: [{date:'YYYY-MM-DD', total:..., payments:[{id,name,amount,period_no?...}]}]
    é€™è£¡ç”¨ date[:7] åšæœˆä»½åˆ†çµ„
    #}

    {% set ns = namespace(month=None, open_month=False) %}
    {% set month_sum = namespace(income=0, exp=0, net=0, key="") %}

    {% for g in groups %}
    {% set m = g.date[:7] %}

    {# å…ˆç®—é€™å¤©çš„é–‹éŠ·èˆ‡æ·¨åˆ©ï¼ˆä¹‹å¾Œé¡¯ç¤º & æœˆçµ±è¨ˆç”¨ï¼‰ #}
    {% set ex = expense_map.get(g.date) %}
    {% set exp_total = ex.total if ex else 0 %}
    {% set net_total = g.total - exp_total %}

    {% if ns.month != m %}
    {# å…ˆé—œé–‰ä¸Šä¸€å€‹æœˆä»½ï¼šé—œé–‰å‰æŠŠæœˆçµ±è¨ˆå¡åˆ° summary çš„ data-*ï¼ˆç”¨ JS é¡¯ç¤ºä¹Ÿè¡Œï¼‰ #}
    {% if ns.open_month %}
  </div>
  </details>
  {% endif %}

  {% set ns.month = m %}
  {% set ns.open_month = True %}
  {% set month_sum.income = 0 %}
  {% set month_sum.exp = 0 %}
  {% set month_sum.net = 0 %}
  {% set month_sum.key = m %}

  <details class="month-block" data-month="{{ m }}" open>
    <summary class="month-summary">
      <span>ğŸ“… {{ m }}</span>
      <span class="month-meta" id="month-meta-{{ m|replace('-', '') }}">
        ç•¶æœˆçµ±è¨ˆè¼‰å…¥ä¸­â€¦
      </span>
    </summary>
    <div class="month-body" style="margin: 10px 0 18px 0;">
      {% endif %}

      {# æœˆçµ±è¨ˆç´¯åŠ  #}
      {% set month_sum.income = month_sum.income + g.total %}
      {% set month_sum.exp = month_sum.exp + exp_total %}
      {% set month_sum.net = month_sum.net + net_total %}

      {# æ¯ä¸€å¤©ï¼šç¸®åœ– -> é»é–‹æ‰çœ‹åˆ°å…§å®¹ #}
      <details class="day-block" data-date="{{ g.date }}" data-month="{{ m }}"
        data-search="{{ (g.date ~ ' ' ~ (g.payments|map(attribute='name')|join(' ')))|lower }}"
        data-income="{{ g.total }}" data-exp="{{ exp_total }}" data-net="{{ net_total }}">
        <summary class="day-thumb">
          <span><b>{{ g.date }}</b></span>
          <span class="day-total">
            ç¸½æ”¶ï¼š{{ g.total }}ã€€
            ç¸½é–‹éŠ·ï¼š{{ exp_total }}ã€€
            æ·¨åˆ©ï¼š{{ net_total }}
          </span>
        </summary>

        <div class="card day-body">
          <form method="post" action="/history/delete-multiple" onsubmit="return confirmHistoryBulk('{{ g.date }}');"
            style="margin:0;">
            <div class="bulk-bar">
              <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" onclick="toggleSelectAllDay('{{ g.date|replace('-', '') }}', this)"> å…¨é¸
              </label>

              <div class="tiny" id="picked-{{ g.date|replace('-', '') }}">å·²å‹¾é¸ 0 ç­†</div>

              <button class="btn danger" type="submit">åˆªé™¤å‹¾é¸</button>
            </div>

            <div id="day-{{ g.date|replace('-', '') }}">
              {% for it in g.payments %}
              <div class="pay-item">
                <div class="pay-left">
                  <input type="checkbox" name="payment_ids" value="{{ it.id }}"
                    onchange="updatePickedCount('{{ g.date|replace('-', '') }}')">
                  <span>
                    âœ… {{ it.name }}
                    {% if it.period_no %}/ç¬¬{{ it.period_no }}æœŸ{% endif %}
                    /å¯¦æ”¶{{ it.amount }}
                  </span>
                </div>
              </div>
              {% endfor %}
            </div>
          </form>

          {% if ex and ex.expenses and ex.expenses|length > 0 %}
          <hr style="margin:12px 0; border:none; border-top:1px solid #eee;">
          <details class="expense-detail">
            <summary style="font-weight:800;">ğŸ§¾ ç•¶æ—¥é–‹éŠ·æ˜ç´°ï¼ˆåˆè¨ˆ {{ exp_total }}ï¼‰</summary>
            <div style="padding:10px 0 0 0;">
              {% for e in ex.expenses %}
              <div class="pay-item">
                <div class="pay-left">
                  <span>â€¢ {{ e.item }}/{{ e.amount }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
          </details>
          {% else %}
          <div class="muted2" style="margin-top:10px;">ç•¶æ—¥ç„¡é–‹éŠ·</div>
          {% endif %}
        </div>
      </details>

      {# è¿´åœˆçµæŸè¦æ”¶å°¾æœ€å¾Œä¸€å€‹æœˆä»½å®¹å™¨ #}
      {% if loop.last and ns.open_month %}
    </div>
  </details>
  {% endif %}

  {% endfor %}
  {% endif %}
  </div>

  <script>
    function toggleSelectAllDay(dayKey, master) {
      const box = document.getElementById('day-' + dayKey);
      if (!box) return;
      box.querySelectorAll('input[name="payment_ids"]').forEach(cb => cb.checked = master.checked);
      updatePickedCount(dayKey);
    }

    function updatePickedCount(dayKey) {
      const box = document.getElementById('day-' + dayKey);
      if (!box) return;
      const checked = box.querySelectorAll('input[name="payment_ids"]:checked').length;
      const el = document.getElementById('picked-' + dayKey);
      if (el) el.textContent = `å·²å‹¾é¸ ${checked} ç­†`;
    }

    function confirmHistoryBulk(dateStr) {
      const dayKey = dateStr.replaceAll('-', '');
      const box = document.getElementById('day-' + dayKey);
      if (!box) {
        alert('æ‰¾ä¸åˆ°è©²æ—¥æœŸçš„é …ç›®');
        return false;
      }
      const checked = box.querySelectorAll('input[name="payment_ids"]:checked').length;
      if (checked === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„ç¹³æ¬¾ç´€éŒ„');
        return false;
      }
      return confirm(`ç¢ºå®šè¦åˆªé™¤ ${checked} ç­†ï¼ˆ${dateStr}ï¼‰çš„ç¹³æ¬¾ç´€éŒ„å—ï¼Ÿ`);
    }

    function toggleAllMonths(open) {
      document.querySelectorAll('details.month-block').forEach(d => d.open = !!open);
      applySearch();
    }

    function toggleAllDays(open) {
      // åªå½±éŸ¿ç›®å‰å¯è¦‹çš„æ—¥æœŸï¼ˆé¿å…åœ¨æœå°‹æ™‚æŠŠéš±è—çš„ä¹Ÿå±•é–‹ï¼‰
      document.querySelectorAll('details.day-block:not(.hidden)').forEach(d => d.open = !!open);
    }

    function applySearch() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      let shownDays = 0;
      let totalDays = 0;

      // å…ˆéæ¿¾æ¯ä¸€å¤©
      document.querySelectorAll('details.day-block').forEach(d => {
        totalDays++;
        const hay = d.getAttribute('data-search') || '';
        const ok = (!q) || hay.includes(q);
        d.classList.toggle('hidden', !ok);
        if (ok) shownDays++;
      });

      // å†æŠŠã€Œæ•´å€‹æœˆä»½ã€å¦‚æœåº•ä¸‹æ²’æœ‰å¯è¦‹æ—¥æœŸå°±éš±è—
      document.querySelectorAll('details.month-block').forEach(m => {
        const hasVisible = m.querySelector('details.day-block:not(.hidden)') !== null;
        m.classList.toggle('hidden', !hasVisible);
      });

      const info = document.getElementById('countInfo');
      if (info) info.textContent = `é¡¯ç¤º ${shownDays} / ${totalDays} å¤©`;

      // æ›´æ–°æœˆä»½çµ±è¨ˆï¼ˆåªçµ±è¨ˆå¯è¦‹æ—¥æœŸï¼‰
      refreshMonthMeta();
    }

    function refreshMonthMeta() {
      const months = {};
      document.querySelectorAll('details.day-block:not(.hidden)').forEach(d => {
        const m = d.getAttribute('data-month') || '';
        const income = Number(d.getAttribute('data-income') || '0');
        const exp = Number(d.getAttribute('data-exp') || '0');
        const net = Number(d.getAttribute('data-net') || '0');
        if (!months[m]) months[m] = { income: 0, exp: 0, net: 0 };
        months[m].income += income;
        months[m].exp += exp;
        months[m].net += net;
      });

      document.querySelectorAll('details.month-block').forEach(mb => {
        const m = mb.getAttribute('data-month') || '';
        const key = m.replaceAll('-', '');
        const el = document.getElementById('month-meta-' + key);
        const s = months[m] || { income: 0, exp: 0, net: 0 };
        if (el) el.textContent = `ç•¶æœˆç¸½æ”¶ ${s.income}ã€€ç¸½é–‹éŠ· ${s.exp}ã€€æ·¨åˆ© ${s.net}`;
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–æ¯ä¸€å¤©å‹¾é¸æ•¸
      document.querySelectorAll('[id^="day-"]').forEach(box => {
        const dayKey = box.id.replace('day-', '');
        updatePickedCount(dayKey);
      });

      // åˆå§‹åŒ–æœˆä»½çµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰
      refreshMonthMeta();

      // æœå°‹
      document.getElementById('searchInput').addEventListener('input', applySearch);
    });
  </script>
</body>

</html>