<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é€£çµå¸³è™Ÿï½œæœˆæ·¨åˆ©</title>
  <link rel="stylesheet" href="/static/style.css?v=1003">
  <style>
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .inline { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .danger-box { border:1px solid #fecaca; background:#fff5f5; }
    .ok-box { border:1px solid #bbf7d0; background:#f0fff4; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 720px){ .grid2{ grid-template-columns:1fr; } }
    .mini { font-size:13px; color:#666; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
    .tag { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">

    <div class="card topbar">
      <div>
        <h2 style="margin:0;">ğŸ‘¥ é€£çµå¸³è™Ÿï½œæœˆæ·¨åˆ©</h2>
        <div class="mini" style="margin-top:6px;">
          ä¸»å¸³è™Ÿï¼š<b>{{ user.display_name if user.display_name else user.username }}</b>
          <span style="opacity:.7;">ï¼ˆ{{ user.username }}ï¼‰</span>
        </div>
      </div>

      <div class="inline">
        <label class="mini" style="display:flex; gap:8px; align-items:center;">
          æœˆä»½
          <input id="ym" type="month" value="{{ show_ym }}" style="padding:9px 12px; border:1px solid #ddd; border-radius:10px;">
        </label>
        <a class="btn" href="/">â† è¿”å›é¦–é </a>
      </div>
    </div>

    {% if msg %}
    <div class="card {% if group_access_ok %}ok-box{% else %}danger-box{% endif %}">
      <b>{{ msg }}</b>
    </div>
    {% endif %}

    {% if not group_access_ok %}
    <div class="card danger-box">
      <div style="font-weight:800; margin-bottom:6px;">â›” é€£çµå¸³è™ŸåŠŸèƒ½æœªé–‹é€š</div>
      <div class="mini">
        {% if group_access_mode == "expired" %}
          è©¦ç”¨å·²åˆ°æœŸï¼Œè«‹åˆ°å¾Œå°é–‹é€šã€Œé€£çµå¸³è™ŸåŠŸèƒ½ã€ã€‚
        {% else %}
          å°šæœªé–‹é€šï¼Œè«‹åˆ°å¾Œå°é–‹é€šã€Œé€£çµå¸³è™ŸåŠŸèƒ½ã€ã€‚
        {% endif %}
      </div>
    </div>
    {% else %}
    <div class="card ok-box">
      <div class="mini">
        {% if group_access_mode == "trial" %}
          ğŸ§ª è©¦ç”¨ä¸­ï½œåˆ°æœŸï¼š<b>{{ group_access_until }}</b>
        {% elif group_access_mode == "activated" %}
          âœ… å·²é–‹é€šï½œåˆ°æœŸï¼š<b>{{ group_access_until }}</b>
        {% else %}
          âœ… å¯ä½¿ç”¨
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="grid2">
      <div class="card">
        <h2 style="margin:0 0 10px;">â• æ–°å¢é€£çµå¸³è™Ÿ</h2>

        {% if group_access_ok %}
        <form method="post" action="/group/link/add" class="form-grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
          <label>å­å¸³è™Ÿï¼ˆusernameï¼‰
            <input type="text" name="child_username" placeholder="ä¾‹å¦‚ï¼šuser02" required>
          </label>

          <label>å­å¸³è™Ÿå¯†ç¢¼
            <input type="password" name="child_password" placeholder="è«‹è¼¸å…¥å­å¸³è™Ÿå¯†ç¢¼" required>
          </label>

          <button class="btn primary" type="submit">é€£çµ</button>
        </form>

        <div class="mini" style="margin-top:10px;">
          â€» å­å¸³è™Ÿåªèƒ½è¢«ä¸€å€‹ä¸»å¸³è™Ÿé€£çµï¼ˆé¿å…é‡è¤‡æˆæ¬Šï¼‰
        </div>
        {% else %}
        <div class="mini">ç›®å‰æœªé–‹é€šï¼Œç„¡æ³•æ–°å¢é€£çµã€‚</div>
        {% endif %}
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px;">ğŸ“Œ å·²é€£çµå¸³è™Ÿ</h2>

        {% if linked_accounts and linked_accounts|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>åç¨±</th>
              <th>å¸³è™Ÿ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for a in linked_accounts %}
            <tr>
              <td>{{ a.display_name if a.display_name else a.username }}</td>
              <td class="mini">{{ a.username }}</td>
              <td>
                {% if group_access_ok %}
                <form method="post" action="/group/link/delete" style="margin:0;">
                  <input type="hidden" name="link_id" value="{{ a.link_id }}">
                  <button class="btn danger" type="submit" onclick="return confirm('ç¢ºå®šè¦è§£é™¤é€£çµï¼Ÿ');">è§£é™¤</button>
                </form>
                {% else %}
                <span class="tag">æœªé–‹é€š</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="mini">ç›®å‰å°šæœªé€£çµä»»ä½•å¸³è™Ÿ</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">ğŸ“ˆ æœ¬æœˆæ·¨åˆ©ï¼ˆä¾å¸³è™Ÿï¼‰</h2>
        <div class="tag">æœˆä»½ï¼š<b>{{ show_ym }}</b></div>
      </div>

      {% if group_summary and group_summary.per_user and group_summary.per_user|length > 0 %}
      <div style="margin-top:12px;">
        {% for u in group_summary.per_user %}
        {% set net = u.month_net %}
        <div class="card" style="margin:0 0 10px; border:1px solid #eee;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:800;">{{ u.display_name if u.display_name else u.username }}</div>
              <div class="mini">å¸³è™Ÿï¼š{{ u.username }}</div>
            </div>

            <div class="tag" style="{% if net < 0 %}border-color:#fecaca; background:#fff5f5;{% else %}border-color:#bbf7d0; background:#f0fff4;{% endif %}">
              ğŸ—“ï¸ æœˆæ·¨åˆ©ï¼š<b>{{ net }}</b>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="tag" style="margin-top:8px;">
        ğŸ“Š é€£çµå¸³è™Ÿåˆè¨ˆï¼š<b>{{ group_summary.month_total }}</b>
      </div>
      {% else %}
      <div class="mini" style="margin-top:10px;">å°šæœªé€£çµä»»ä½•å¸³è™Ÿï¼ˆæˆ–æœ¬æœˆæ²’æœ‰è³‡æ–™ï¼‰</div>
      {% endif %}
    </div>

  </div>

  <script>
    (function () {
      const el = document.getElementById('ym');
      if (!el) return;
      el.addEventListener('change', function () {
        const v = el.value;
        if (!v) return;
        window.location.href = '/group-month?ym=' + encodeURIComponent(v);
      });
    })();
  </script>
</body>
</html>
