<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åˆ†æœŸè¨˜å¸³</title>
  <link rel="stylesheet" href="/static/style.css?v=999">
</head>
<body>
  <div class="container">
    <h1>åˆ†æœŸè¨˜å¸³</h1>

    {% if paid_msg %}
      <div class="card">
        <p><b>{{ paid_msg }}</b></p>
      </div>
    {% endif %}

    {% if not user %}
      <div class="card">
        <h2>ç™»å…¥</h2>
        <form method="post" action="/login" class="form-grid">
          <label>å¸³è™Ÿ
            <input type="text" name="username" required>
          </label>
          <label>å¯†ç¢¼
            <input type="password" name="password" required>
          </label>
          <button type="submit" class="btn primary">ç™»å…¥</button>
        </form>
      </div>

      <div class="card">
        <h2>è¨»å†Š</h2>
        <form method="post" action="/register" class="form-grid">
          <label>å¸³è™Ÿ
            <input type="text" name="username" required>
          </label>
          <label>å¯†ç¢¼
            <input type="password" name="password" required>
          </label>
          <button type="submit" class="btn primary">è¨»å†Šä¸¦ç™»å…¥</button>
        </form>
      </div>

    {% else %}

      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div>ç›®å‰ç™»å…¥ï¼š<b>{{ user.username }}</b></div>
        <form method="post" action="/logout" style="margin:0;">
          <button class="btn">ç™»å‡º</button>
        </form>
      </div>

      <div class="layout">

        <!-- å·¦é‚Šï¼šåŠŸèƒ½ + ç›®å‰è³‡æ–™ -->
        <div class="main">

        <!-- âœ… åŠŸèƒ½ -->
        <div class="card" style="text-align:center;">
          <h2>åŠŸèƒ½</h2>

        <div style="display:flex; justify-content:center; gap:12px;">
          <a class="btn primary" href="/add-page">ï¼‹ æ–°å¢è³‡æ–™</a>
          <a class="btn" href="/history">ğŸ“„ æ­·å²ç¹³æ¬¾</a>
        </div>
      </div>

          <!-- âœ… ç›®å‰è³‡æ–™ -->
          <div class="card">
            <h2>ç›®å‰è³‡æ–™</h2>

            {% if rows|length == 0 %}
              <p class="muted">ç›®å‰æ²’æœ‰è³‡æ–™</p>
            {% else %}
              <div class="list">
                {% for r in rows %}
                  <div class="row">
                    <div class="row-main">
                      <div class="title">{{ r.name }}</div>
                      <div class="meta">
                        å»ºç«‹æ—¥ï¼š{{ r.created_date }}
                        ï½œ ç¥¨é¢ {{ r.face_value }}
                        ï½œ æ”¯å‡º {{ r.total_amount }}/é¤˜ {{ (r.total_amount - (r.paid_count * r.amount)) if (r.total_amount - (r.paid_count * r.amount)) > 0 else 0 }}
                        ï½œ {{ r.periods }} æœŸ/é¤˜ {{ (r.periods - r.paid_count) if (r.periods - r.paid_count) > 0 else 0 }} æœŸ
                        ï½œ æ¯æœŸ {{ r.amount }}
                      </div>

                      <div class="notice">
                        é€±æœŸï¼šæ¯ {{ r.interval_days }} å¤©ä¸€æ¬¡
                        {% if r.finished %}
                          <!-- å·²çµæ¸…ä¸é¡¯ç¤º -->
                        {% elif r.days_left == 0 %}
                          ï½œ <b>ğŸ”” ä»Šå¤©è¦ç¹³æ¬¾</b>
                        {% elif r.days_left > 0 %}
                          ï½œ é‚„æœ‰ <b>{{ r.days_left }}å¤©</b>
                        {% else %}
                          ï½œ <b>å·²é€¾æœŸ {{ -r.days_left }}å¤©</b>
                        {% endif %}
                      </div>
                    </div>

                    <div class="row-actions">
                      {% if r.finished %}
                        <p style="color: green; font-weight: bold;">âœ… å·²çµæ¸…</p>

                      {% elif paid_id and r.id == paid_id %}
                        <p style="color: #0a7; font-weight: bold;">âœ… ç¹³æ¬¾å®Œæˆ</p>

                      {% elif r.is_due_today %}
                        <form action="/pay/{{ r.id }}" method="post">
                          <button class="btn">ä»Šæ—¥å·²ç¹³æ¬¾</button>
                        </form>

                      {% elif r.is_overdue %}
                        <p style="color: red; font-weight: bold;">â— æœªå®Œæˆç¹³æ¬¾</p>
                        <form action="/pay/{{ r.id }}" method="post">
                          <button class="btn">è£œç¹³</button>
                        </form>

                      {% else %}
                        <p style="color: gray;">å°šæœªåˆ°ç¹³æ¬¾æ—¥</p>
                      {% endif %}

                      <a class="btn" href="/edit/{{ r.id }}">ç·¨è¼¯</a>

                      <form method="post" action="/delete/{{ r.id }}" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ');">
                        <button class="btn danger" type="submit">åˆªé™¤</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        </div>

        <!-- å³é‚Šï¼šé€šçŸ¥ -->
        <div class="side">

          <!-- âœ… ä»Šæ—¥ç¸½æ”¶é‡‘é¡ + æ­·å²æŒ‰éˆ• -->
          <div class="card">
            <h2>ä»Šæ—¥ç¸½æ”¶é‡‘é¡</h2>
            <p style="font-size: 22px; margin: 0;"><b>{{ today_total }}</b></p>
            <div style="margin-top: 10px;">
              <a class="btn primary" href="/history">ğŸ“Š æ­·å²ç¹³æ¬¾é </a>
            </div>
          </div>

          <div class="card">
            <h2>é€šçŸ¥</h2>

            <h3>ä»Šæ—¥ç¹³æ¬¾</h3>
            {% if today_due_records|length == 0 %}
              <p>ä»Šå¤©æ²’æœ‰åˆ°æœŸçš„ç¹³æ¬¾</p>
            {% else %}
              <ul>
              {% for r in today_due_records %}
                <li>
                  ğŸ”” {{ r.name }}ï¼ˆç¬¬ {{ r.paid_count + 1 }} / {{ r.periods }} æœŸï¼Œ{{ r.amount }} å…ƒï¼‰
                  <form action="/pay/{{ r.id }}" method="post" style="display:inline;">
                    <button class="btn" type="submit">æ–°å¢ç¹³æ¬¾</button>
                  </form>
                </li>
              {% endfor %}
              </ul>
            {% endif %}

            <h3>æœªå®Œæˆç¹³æ¬¾ï¼ˆé€¾æœŸï¼‰</h3>
            {% if overdue_records|length == 0 %}
              <p>ç›®å‰æ²’æœ‰é€¾æœŸ</p>
            {% else %}
              <ul>
              {% for r in overdue_records %}
                <li>
                  â— {{ r.name }}ï¼ˆå·²é€¾æœŸ {{ -r.days_left }} å¤©ï¼‰
                  <form action="/pay/{{ r.id }}" method="post" style="display:inline;">
                    <button class="btn" type="submit">è£œç¹³</button>
                  </form>
                </li>
              {% endfor %}
              </ul>
            {% endif %}
          </div>

        </div>
      </div>

      <script>
        const due = {{ due_today_count }};
        if (due > 0) {
          alert("ğŸ”” ä»Šå¤©æœ‰ " + due + " ç­†è¦ç¹³æ¬¾");
        }
      </script>

    {% endif %}
  </div>
</body>
</html>