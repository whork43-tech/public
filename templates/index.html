<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åˆ†æœŸå€Ÿæ¬¾ç®¡ç†å¹³å°</title>
  <link rel="stylesheet" href="/static/style.css?v=1003">

  <style>
    /* é€šçŸ¥å€ï¼šæ¯å€æœ€å¤šé¡¯ç¤ºç´„ 5 ç­†ï¼Œè¶…éå°±æ²å‹• */
    .notice-list {
      max-height: 210px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .notice-list li {
      margin-bottom: 8px;
    }

    /* ç›®å‰è³‡æ–™ï¼šå¤šç­†åˆªé™¤æ¨¡å¼ */
    #bulkBar {
      display: none;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .bulkBox {
      display: none;
      padding: 10px 8px 0 0;
    }

    .bulk-mode #bulkBar {
      display: flex;
    }

    .bulk-mode .bulkBox {
      display: block;
    }

    /* å°å·¥å…·ï¼šis-hidden */
    .is-hidden {
      display: none !important;
    }

    /* ===== UI Theme Upgrade ===== */
    :root {
      --bg1: #f7f9fc;
      --bg2: #eef3ff;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17, 24, 39, .08);
      --shadow: 0 10px 30px rgba(17, 24, 39, .08);
      --shadow2: 0 6px 16px rgba(17, 24, 39, .06);
      --radius: 16px;
    }

    body {
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, var(--bg2), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, #ffe7f0, transparent 55%),
        linear-gradient(180deg, var(--bg1), #ffffff 60%);
    }

    .container {
      max-width: 1100px;
      /* è®“ç•«é¢æ›´ä¸æ“æ“  */
    }

    h1 {
      margin: 18px 0 6px;
      letter-spacing: .5px;
    }

    /* æ¨™é¡Œä¸‹å‰¯æ¨™èª */
    .tagline {
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(6px);
    }

    /* è®“ä¸»è¦å€å¡Šæ›´æœ‰å±¤æ¬¡ */
    .layout {
      gap: 16px;
    }

    /* å³å´é€šçŸ¥æ¬„ä¸è¦å¤ªçª„ */
    .side {
      min-width: 320px;
    }

    /* Segmented buttons æ›´åƒç³»çµ± */
    .seg {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .seg-btn {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(17, 24, 39, .06);
      transition: .15s;
    }

    .seg-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(17, 24, 39, .10);
    }

    .seg-btn.active {
      border-color: rgba(59, 130, 246, .25);
      box-shadow: 0 10px 22px rgba(59, 130, 246, .12);
    }

    /* è¡¨å–®æ›´å¥½çœ‹ */
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      border-radius: 12px !important;
      border: 1px solid rgba(17, 24, 39, .12) !important;
      padding: 10px 12px !important;
      outline: none;
    }

    input:focus {
      border-color: rgba(59, 130, 246, .5) !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, .12);
    }

    /* åˆ—è¡¨ row æ›´æ¸…æ¥š */
    .row {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(17, 24, 39, .06);
    }

    .row .title {
      font-size: 18px;
      font-weight: 800;
    }

    .meta {
      color: var(--muted);
    }

    /* å¸³æˆ¶ç‹€æ…‹å¡æ›´åƒæç¤ºæ¢ */
    .statusbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(17, 24, 39, .02);
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    .pill b {
      color: var(--text);
    }

    .pill.trial {
      background: rgba(245, 158, 11, .10);
      border-color: rgba(245, 158, 11, .20);
    }

    .pill.ok {
      background: rgba(16, 185, 129, .10);
      border-color: rgba(16, 185, 129, .20);
    }

    .pill.bad {
      background: rgba(220, 38, 38, .10);
      border-color: rgba(220, 38, 38, .20);
    }

    /* paid_msg æ›´åƒæé†’ */
    .notice-card {
      border-left: 6px solid rgba(59, 130, 246, .35);
    }

    /* âœ… é˜²æ­¢åŠŸèƒ½/é¡¯ç¤ºå€å¡Šè¶…å‡ºé é¢ï¼ˆé¿å…æ°´å¹³æ²å‹•ï¼‰ */
    .container {
      width: min(1100px, 100%);
      margin: 0 auto;
      padding: 0 14px;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 16px;
      max-width: 100%;
      box-sizing: border-box;
    }

    .main {
      flex: 1 1 520px;
      min-width: 0;
    }

    .side {
      flex: 0 1 360px;
      min-width: 280px;
      max-width: 100%;
    }

    .card {
      max-width: 100%;
      box-sizing: border-box;
    }

    /* åŠŸèƒ½æŒ‰éˆ•ä¸€è¡Œå¤ªé•·æ™‚è‡ªå‹•æ›è¡Œ */
    .feature-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .feature-card .feature-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .feature-card .feature-actions .btn {
      margin-left: 0 !important;
    }

    /* æ”¶è²»èªªæ˜ï¼šç¸®å°æŒ‰éˆ• */
    .pricing-mini-btn {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      opacity: .9;
    }

    .pricing-mini-btn:hover {
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>åˆ†æœŸå€Ÿæ¬¾ç®¡ç†å¹³å°</h1>
    <p class="tagline">è®“æ¯ä¸€ç­†åˆ†æœŸï¼Œéƒ½æ¸…æ¥šå¯æ§</p>

    {% if paid_msg %}
    <div class="card notice-card">
      <p><b>{{ paid_msg }}</b></p>
    </div>

    {% endif %}

    <!-- âœ… æœªç™»å…¥ï¼šåªé¡¯ç¤ºç™»å…¥/è¨»å†Šï¼Œä¸æ¸²æŸ“ä»»ä½•è³‡æ–™å€ -->
    {% if not user %}
    <div class="card">
      <h2>ç™»å…¥</h2>
      <form method="post" action="/login" class="form-grid">
        <label>å¸³è™Ÿ
          <input type="text" name="username" required>
        </label>
        <label>å¯†ç¢¼
          <input type="password" name="password" required>
        </label>
        <button type="submit" class="btn primary">ç™»å…¥</button>
      </form>
    </div>

    <div class="card">
      <h2>è¨»å†Š</h2>
      <form method="post" action="/register" class="form-grid">
        <label>åç¨±
          <input type="text" name="display_name" placeholder="ä¾‹å¦‚ï¼šé˜¿å®‡ / ç‹å…ˆç”Ÿ" required>
        </label>
        <label>å¸³è™Ÿ
          <input type="text" name="username" required>
        </label>
        <label>å¯†ç¢¼
          <input type="password" name="password" required>
        </label>
        <button type="submit" class="btn primary">è¨»å†Šä¸¦ç™»å…¥</button>
      </form>
    </div>

    {% else %}
    <!-- ğŸ’° æ”¶è²»èªªæ˜ï¼ˆæœªé–‹é€š / è©¦ç”¨é¡¯ç¤ºï¼‰ -->
    {% if user and access_mode != "activated" %}
    <div class="card" style="margin-top:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">æ”¶è²»èªªæ˜</h2>
        <button type="button" class="btn pricing-mini-btn" id="btnTogglePricing" onclick="togglePricing()">ç¸®å°</button>
      </div>

      <div id="pricingBody">
        <p>
          æœ¬ç³»çµ±ç‚º <b>å€‹äººæ”¾æ¬¾å°ˆç”¨</b> çš„åˆ†æœŸå¸³å‹™ç®¡ç†å·¥å…·ï¼Œ
          å”åŠ©ä½ æ¸…æ¥šæŒæ¡æ¯ä¸€ç­†æ”¶æ¬¾èˆ‡æ”¯å‡ºï¼Œé¿å…ç®—éŒ¯ã€æ¼å¸³ã€‚
        </p>

        <ul style="padding-left:18px; line-height:1.8;">
          <li>ğŸ§ª <b>å…è²»è©¦ç”¨ 7 å¤©</b>ï¼ˆä¸»åŠŸèƒ½å®Œæ•´é–‹æ”¾ï¼‰</li>
          <li>ğŸ’¼ ä¸»åŠŸèƒ½é–‹é€šï¼š<b>NT$ 299 / æœˆ</b></li>
          <li>ğŸ‘¥ é€£çµå¸³è™ŸåŠ è³¼ï¼š<b>NT$ 199 / æœˆ</b>ï¼ˆä¸æä¾›è©¦ç”¨ï¼‰</li>
          <li>ğŸ“¤ Telegram å›å ± + Excel åŒ¯å‡ºåŠ è³¼ï¼š<b>NT$ 199 / æœˆ</b>ï¼ˆä¸æä¾›è©¦ç”¨ï¼‰</li>
          <li>ğŸ“ åˆ°æœŸæœªçºŒè²» <b>è³‡æ–™ä¸æœƒåˆªé™¤</b></li>
          <li>ğŸ” çºŒè²»å¾Œç«‹å³æ¢å¾©ä½¿ç”¨</li>
        </ul>

        <hr style="margin:14px 0; opacity:.2;" />
        <h3 style="margin:0 0 8px; font-size:16px;">åŠŸèƒ½ç°¡ä»‹</h3>
        <ul style="padding-left:18px; line-height:1.8; margin-top:0;">
          <li>ğŸ“ æ–°å¢åˆ†æœŸè³‡æ–™ï¼šè‡ªå‹•è¨ˆç®—æœŸæ•¸ã€æ¯æœŸé‡‘é¡ã€åˆ°æœŸæé†’</li>
          <li>ğŸ’° ä»Šæ—¥å¯¦æ”¶ / ä»Šæ—¥æ·¨åˆ© / æœ¬æœˆæ·¨åˆ©ï¼šé¦–é å³æ™‚é¡¯ç¤º</li>
          <li>ğŸ« ç¸½ç¥¨é¢ / ç¥¨é¢(é¤˜)ï¼šæŒæ¡æœªæ”¶ç¥¨é¢èˆ‡å‰©é¤˜</li>
          <li>ğŸ”” é€šçŸ¥ï¼šä»Šæ—¥åˆ°æœŸã€æ˜æ—¥åˆ°æœŸã€é€¾æœŸè£œç¹³æé†’</li>
          <li>ğŸ§¾ æ­·å²ç¹³æ¬¾ï¼šä¾æœˆ/æ—¥å½™ç¸½ã€æ˜ç´°æŸ¥çœ‹ã€æ”¯æ´æ‰¹æ¬¡åˆªé™¤</li>
          <li>ğŸ‘¥ é€£çµå¸³è™Ÿï¼ˆåŠ è³¼ï¼‰ï¼šä¸»å¸³è™Ÿæ•´åˆå¤šå¸³è™Ÿæ·¨åˆ©/å¯¦æ”¶/é–‹éŠ·/ç¥¨é¢</li>
          <li>ğŸ“¤ Telegram å›å ± + Excel åŒ¯å‡ºï¼ˆåŠ è³¼ï¼‰ï¼šå‹¾é¸è¦å›å ±/åŒ¯å‡ºçš„è³‡æ–™</li>
        </ul>

        <p style="margin-bottom:0;">
          ğŸ“© é–‹é€šæˆ–çºŒè²»è«‹è¯çµ¡ LINEï¼š<b>@826ynmlh</b>
        </p>
      </div>
    </div>

    {% endif %}

    <!-- âœ… å·²ç™»å…¥ï¼šæ‰æ¸²æŸ“ä¸»ç•«é¢ -->
    <div class="card"
      style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
      <div>
        ç›®å‰ç™»å…¥ï¼š
        <b>{{ user.display_name if user.display_name else user.username }}</b>
        <span style="opacity:.6; font-size:13px;">ï¼ˆ{{ user.username }}ï¼‰</span>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <a class="btn" href="/change_password">æ›´æ”¹å¯†ç¢¼</a>
        <form method="post" action="/logout" style="margin:0;">
          <button class="btn">ç™»å‡º</button>
        </form>
      </div>
    </div>


    <!-- ğŸ” å¸³æˆ¶ç‹€æ…‹ï¼ˆè©¦ç”¨ / å·²é–‹é€š / åˆ°æœŸï¼‰ -->
    <div class="card statusbar" style="margin-top:10px;">
      {% if access_mode == "trial" %}
      <span class="pill trial">ğŸ§ª <b>è©¦ç”¨ä¸­</b>ï½œåˆ°æœŸæ—¥ï¼š<b>{{ access_until }}</b></span>
      <span class="pill">éœ€è¦å»¶é•·ï¼Ÿè«‹è¯çµ¡ LINEï¼š<b>@826ynmlh</b></span>

      {% elif access_mode == "activated" %}
      <span class="pill ok">âœ… <b>å·²é–‹é€š</b>ï½œåˆ°æœŸæ—¥ï¼š<b>{{ access_until }}</b></span>
      <span class="pill">åˆ°æœŸå¯çºŒè²»å»¶é•·ï¼ˆLINEï¼š<b>@826ynmlh</b>ï¼‰</span>

      {% else %}
      <span class="pill bad">â›” <b>è©¦ç”¨æœŸå·²çµæŸ</b>ï½œè«‹è¯çµ¡ LINEï¼š<b>@826ynmlh</b></span>
      {% endif %}
    </div>

    {% if access_ok %}
    <div class="layout">

      <!-- å·¦é‚Šï¼šåŠŸèƒ½ -->
      <div class="main">

        <!-- åŠŸèƒ½ï¼šæ–°å¢ï¼ˆè·³é ï¼‰ -->
        <!-- åŠŸèƒ½ï¼šæ–°å¢ï¼ˆè·³é ï¼‰ -->
        <div class="card feature-card" style="text-align:center;">
          <h2>åŠŸèƒ½</h2>

          <div class="feature-actions">
            <a class="btn primary" href="/add-page">ï¼‹ æ–°å¢è³‡æ–™</a>
            <a class="btn" href="/expense-page">ï¼‹ æ–°å¢é–‹éŠ·</a>
            <a class="btn" href="/history">ğŸ“„ æ­·å²ç¹³æ¬¾</a>



            {% if group_is_child %}
            <a class="btn danger" href="javascript:void(0);" onclick="return false;"
              style="margin-left:10px; pointer-events:none; opacity:.75; cursor:not-allowed;">
              ğŸ‘¥ é€£çµå¸³è™Ÿï¼ˆå­å¸³è™Ÿä¸å¯ç”¨ï¼‰
            </a>
            {% elif not group_access_ok %}
            <a class="btn danger" href="javascript:void(0);" onclick="return false;"
              style="margin-left:10px; pointer-events:none; opacity:.75; cursor:not-allowed;">
              ğŸ‘¥ é€£çµå¸³è™Ÿï¼ˆæœªé–‹é€š/å·²åˆ°æœŸï¼‰
            </a>
            {% else %}
            <a class="btn" href="/group-month" style="margin-left:10px;">
              ğŸ‘¥ é€£çµå¸³è™Ÿ
            </a>
            {% endif %}

            {% if not tools_access_ok %}
            <a class="btn danger" href="#" onclick="return false;"
              style="margin-left:10px; pointer-events:none; opacity:.75; cursor:not-allowed;">
              ğŸ“¤ Telegram/EXCLEï¼ˆæœªé–‹é€š/å·²åˆ°æœŸï¼‰
            </a>
            {% else %}
            <a class="btn" href="/tools" style="margin-left:10px;">
              ğŸ“¤ Telegram/EXCLE
            </a>
            {% endif %}

          </div>
        </div>


        <!-- é¡¯ç¤ºåŠŸèƒ½ï¼ˆé›†ä¸­åœ¨åŒä¸€æ’ï¼‰ -->
        <div class="card" style="text-align:center;">
          <div class="seg">
            <button type="button" class="seg-btn" id="btnToggleCurrent" onclick="toggleSection('currentCard', this)">
              ğŸ“Œ é¡¯ç¤ºç›®å‰è³‡æ–™
            </button>

            <button type="button" class="seg-btn" id="btnToggleExpense" onclick="toggleSection('expenseCard', this)">
              ğŸ’¸ é¡¯ç¤ºä»Šæ—¥é–‹éŠ·
            </button>

            <button type="button" class="seg-btn" id="btnToggleToday" onclick="toggleSection('todayCard', this)">
              ğŸ’° é¡¯ç¤ºä»Šæ—¥å¯¦æ”¶/æ·¨åˆ©
            </button>

            <button type="button" class="seg-btn" id="btnToggleFaceTotal"
              onclick="toggleSection('faceTotalCard', this)">
              ğŸŸï¸ é¡¯ç¤ºç¸½ç¥¨é¢/ç¥¨é¢(é¤˜)
            </button>

            <button type="button" class="seg-btn" id="btnToggleNotice" onclick="toggleSection('noticeCard', this)">
              ğŸ”” éš±è—é€šçŸ¥
            </button>
          </div>
        </div>

        <!-- ç›®å‰è³‡æ–™ -->
        <div class="card is-hidden" id="currentCard">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <h2 style="margin:0;">ç›®å‰è³‡æ–™</h2>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <input id="currentSearch" type="text" placeholder="æœå°‹åç¨±â€¦"
                style="padding:9px 12px; border:1px solid #ddd; border-radius:10px; min-width:180px;">
              <button type="button" class="btn danger" onclick="toggleBulkMode()">åˆªé™¤å¤šç­†</button>
            </div>
          </div>

          <!-- å¤šç­†åˆªé™¤å·¥å…·åˆ— -->
          <div id="bulkBar">
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="bulkSelectAll" onclick="toggleSelectAll(this)">
              å…¨é¸
            </label>

            <button class="btn danger" type="submit" form="bulkForm" onclick="return confirmBulkDelete();">
              åˆªé™¤å‹¾é¸
            </button>

            <span class="muted" id="bulkPicked">å·²å‹¾é¸ 0 ç­†</span>
          </div>

          <!-- å¤šç­†åˆªé™¤è¡¨å–®ï¼ˆcheckbox ç”¨ form=bulkForm ç¶é€²ä¾†ï¼‰ -->
          <form id="bulkForm" method="post" action="/delete-multiple"></form>

          <div class="list" style="max-height: 420px; overflow-y: auto; padding-right: 6px;">
            {% set sorted_rows = rows|sort(attribute='interval_days') %}
            {% set ns = namespace(last_interval=None) %}

            {% for r in sorted_rows %}
            {% if ns.last_interval != r.interval_days %}
            {% set ns.last_interval = r.interval_days %}
            <div class="meta" style="margin:10px 0 6px; font-weight:700;">
              âœ… {{ r.interval_days }} å¤©æ”¶æ¬¾
            </div>
            {% endif %}

            <div class="row" data-name="{{ r.name|lower }}">
              <div class="bulkBox">
                <input type="checkbox" name="record_ids" value="{{ r.id }}" form="bulkForm"
                  onchange="updateBulkPicked()">
              </div>

              <div class="row-main">
                <div class="title">{{ r.name }}</div>
                <div class="meta">
                  {% set paid_sum = r.paid_sum if r.paid_sum is defined else 0 %}
                  {% set ticket_offset = r.ticket_offset if r.ticket_offset is defined else 0 %}
                  {% set expense_offset = r.expense_offset if r.expense_offset is defined else 0 %}

                  {# ç¥¨é¢é¤˜ï¼šè¦å‰‡ 2ï¼ˆè·Ÿè‘—æ¯æœŸæ‰£ï¼‰ #}
                  {% set face_left = r.face_value - ticket_offset - paid_sum %}

                  {# æ”¯å‡ºé¤˜ï¼šæ‰£å·²ç¹³ + æ”¯å‡ºé æ‰£ #}
                  {% set spend_left = (r.total_amount - paid_sum - expense_offset) %}

                  {% set periods_left = (r.periods - r.paid_count) %}

                  å»ºç«‹æ—¥ï¼š{{ r.created_date }}
                  ï½œ ç¥¨é¢ {{ r.face_value }}/é¤˜
                  {% if face_left < 0 %} <span style="color:#dc2626; font-weight:700;">{{ face_left }}</span>
                    {% else %}
                    {{ face_left }}
                    {% endif %}

                    ï½œ æ”¯å‡º {{ r.total_amount }}/é¤˜
                    {% if spend_left < 0 %} <span style="color:#dc2626; font-weight:700;">{{ spend_left }}</span>
                      {% else %}
                      {{ spend_left }}
                      {% endif %}

                      ï½œ {{ r.periods }} æœŸ/é¤˜ {{ periods_left if periods_left > 0 else 0 }} æœŸ
                      ï½œ æ¯æœŸ {{ r.amount }}
                </div>

                <div class="notice">
                  é€±æœŸï¼šæ¯ {{ r.interval_days }} å¤©ä¸€æ¬¡
                  {% if r.finished %}
                  {% elif r.days_left == 0 %}
                  ï½œ <b>ğŸ”” ä»Šå¤©è¦ç¹³æ¬¾</b>
                  {% elif r.days_left > 0 %}
                  ï½œ é‚„æœ‰ <b>{{ r.days_left }}å¤©</b>
                  {% else %}
                  ï½œ <b>å·²é€¾æœŸ {{ -r.days_left }}å¤©</b>
                  {% endif %}
                </div>
              </div>

              <div class="row-actions">
                {% if r.finished %}
                <p style="color: green; font-weight: bold;">âœ… å·²çµæ¸…</p>

                {% elif paid_id and r.id == paid_id %}
                <p style="color: #0a7; font-weight: bold;">âœ… ç¹³æ¬¾å®Œæˆ</p>

                {% elif r.is_due_today %}
                <p style="color: #f59e0b; font-weight: bold;">ğŸ”” ä»Šå¤©è¦ç¹³æ¬¾</p>

                {% elif r.is_overdue %}
                <p style="color: red; font-weight: bold;">â— æœªå®Œæˆç¹³æ¬¾</p>
                <p style="color: gray; margin: 6px 0 0;">è«‹åˆ°å³å´é€šçŸ¥å€è£œç¹³</p>

                {% else %}
                <p style="color: gray;">å°šæœªåˆ°ç¹³æ¬¾æ—¥</p>
                {% endif %}

                {% if not r.finished %}
                <form action="/settle/{{ r.id }}" method="post" style="display:flex; gap:6px; align-items:center;">
                  <input type="number" name="amount" min="1" placeholder="çµæ¸…é‡‘é¡" style="width:90px; padding:6px;"
                    required>
                  <button class="btn primary" type="submit">å·²çµæ¸…</button>
                </form>
                {% endif %}

                <a class="btn" href="/edit/{{ r.id }}">ç·¨è¼¯</a>

                <form method="post" action="/delete/{{ r.id }}" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ');">
                  <button class="btn danger" type="submit">åˆªé™¤</button>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

      </div>

      <!-- å³é‚Š -->
      <div class="side">

        <!-- ä»Šæ—¥å¯¦æ”¶ / ä»Šæ—¥æ·¨åˆ© / æœ¬æœˆæ·¨åˆ© -->
        <div id="todayCard" class="is-hidden">
          <div style="display:flex; gap:14px; align-items:stretch; margin-bottom:14px;">
            <div class="card" style="flex:1; margin:0;">
              <h2>ä»Šæ—¥å¯¦æ”¶</h2>
              <p style="font-size: 22px; margin: 0;"><b>{{ today_total }}</b></p>
            </div>

            <div class="card" style="flex:1; margin:0;">
              <h2>ä»Šæ—¥æ·¨åˆ©</h2>
              <p style="font-size: 22px; margin: 0;"><b>{{ today_net }}</b></p>
            </div>

            <div class="card" style="flex:1; margin:0;">
              <h2>æœ¬æœˆæ·¨åˆ©</h2>
              <p style="font-size: 22px; margin: 0;"><b>{{ my_month_net|default(0) }}</b></p>
            </div>
          </div>
        </div> <!-- âœ… todayCard åœ¨é€™è£¡çµæŸï¼Œä¸‹é¢å°±ä¸æœƒè·Ÿè‘—ä¸€èµ·è¢«éš±è— -->

        <!-- ç¸½ç¥¨é¢ / ç¸½ç¥¨é¢(é¤˜) -->
        <div id="faceTotalCard" class="is-hidden">
          <div style="display:flex; gap:14px; align-items:stretch;">
            <div class="card" style="flex:1; margin:0;">
              <h2>ç¸½ç¥¨é¢</h2>
              <p style="font-size: 22px; margin: 0;"><b>{{ total_face_value }}</b></p>
            </div>

            <div class="card" style="flex:1; margin:0;">
              <h2>ç¸½ç¥¨é¢(é¤˜)</h2>
              <p style="font-size: 22px; margin: 0;"><b>{{ total_face_value_left }}</b></p>
            </div>
          </div>
        </div>

        <!-- ä»Šæ—¥é–‹éŠ· -->
        <div class="card is-hidden" id="expenseCard">
          <h2>ä»Šæ—¥é–‹éŠ·</h2>

          <form method="post" action="/expense/delete-multiple" id="expenseBulkForm">
            <div
              style="display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap;">
              <label style="display:flex; align-items:center; gap:6px;">
                <input id="expenseSelectAll" type="checkbox" onclick="toggleExpenseAll(this)">
                å…¨é¸
              </label>

              <div class="muted" id="expensePicked">å·²å‹¾é¸ 0 ç­†</div>

              <button type="submit" class="btn danger" onclick="return confirmExpenseBulk();">
                åˆªé™¤å‹¾é¸
              </button>
            </div>

            <ul>
              {% for e in today_expenses %}
              <li style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" name="expense_ids" value="{{ e.id }}" onchange="updateExpensePicked()">
                <span>â€¢ {{ e.item }}ï¼š{{ e.amount }}</span>
              </li>
              {% endfor %}
            </ul>
          </form>
        </div>

        <!-- é€šçŸ¥ï¼šä»Šæ—¥ç¹³æ¬¾ / æ˜æ—¥ç¹³æ¬¾ / é€¾æœŸï¼ˆå…¨éƒ¨åœ¨åŒä¸€å¼µå¡ï¼‰ -->
        <div class="card" id="noticeCard">
          <h2>é€šçŸ¥</h2>

          <h3>ä»Šæ—¥ç¹³æ¬¾</h3>
          {% if today_due_records|length == 0 %}
          <p>ä»Šå¤©æ²’æœ‰åˆ°æœŸçš„ç¹³æ¬¾</p>
          {% else %}
          <ul class="notice-list">
            {% for r in today_due_records %}
            <li>
              ğŸ”” {{ r.name }}ï¼ˆç¬¬ {{ r.paid_count + 1 }} / {{ r.periods }} æœŸï¼Œ{{ r.amount }} å…ƒï¼‰
              <form action="/pay/{{ r.id }}" method="post" style="display:inline;">
                <button class="btn" type="submit">å·²ç¹³æ¬¾</button>
              </form>
            </li>
            {% endfor %}
          </ul>
          {% endif %}

          <h3>æ˜æ—¥ç¹³æ¬¾</h3>
          {% set ns = namespace(has_tomorrow=false) %}
          <ul class="notice-list">
            {% for r in rows %}
            {% if r.days_left == 1 and (r.paid_count < r.periods) %} {% set ns.has_tomorrow=true %} <li>â³ {{ r.name
              }}ï¼ˆæ˜å¤©åˆ°æœŸï¼Œç¬¬ {{ r.paid_count + 1 }} / {{ r.periods }} æœŸï¼Œ{{ r.amount }} å…ƒï¼‰</li>
              {% endif %}
              {% endfor %}
          </ul>
          {% if not ns.has_tomorrow %}
          <p>æ˜å¤©æ²’æœ‰åˆ°æœŸçš„ç¹³æ¬¾</p>
          {% endif %}

          <h3>é€¾æœŸ</h3>
          {% if overdue_records|length == 0 %}
          <p>ç›®å‰æ²’æœ‰é€¾æœŸ</p>
          {% else %}
          <ul class="notice-list">
            {% for r in overdue_records %}
            <li>
              {% set interval = r.interval_days if r.interval_days and r.interval_days > 0 else 1 %}
              {% set delta = -r.days_left %}
              {% set overdue_raw = ((delta - 1) // interval + 1) if delta > 0 else 0 %}
              {% set remaining = (r.periods - r.paid_count) %}
              {% if remaining < 0 %}{% set remaining=0 %}{% endif %} {% set overdue_periods=overdue_raw if overdue_raw <
                remaining else remaining %} â— {{ r.name }}ï¼ˆé€¾æœŸ {{ overdue_periods }} æœŸï¼‰ <form action="/pay/{{ r.id }}"
                method="post" style="display:inline-flex; align-items:center; gap:6px;">
                (
                <input type="number" name="periods" min="1" value="1" style="width:60px; padding:4px;" required>
                )
                <button class="btn" type="submit">è£œç¹³</button>
                </form>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

      </div>

    </div>
    {% endif %}

    {% endif %}
  </div>

  <script>
    // åˆå§‹åŒ–æŒ‰éˆ•æ–‡å­—èˆ‡ active
    document.addEventListener('DOMContentLoaded', () => {
      initToggle('currentCard', 'btnToggleCurrent', 'ğŸ“Œ é¡¯ç¤ºç›®å‰è³‡æ–™', 'ğŸ“Œ éš±è—ç›®å‰è³‡æ–™');
      initToggle('expenseCard', 'btnToggleExpense', 'ğŸ’¸ é¡¯ç¤ºä»Šæ—¥é–‹éŠ·', 'ğŸ’¸ éš±è—ä»Šæ—¥é–‹éŠ·');
      initToggle('todayCard', 'btnToggleToday', 'ğŸ’° é¡¯ç¤ºä»Šæ—¥å¯¦æ”¶/æ·¨åˆ©', 'ğŸ’° éš±è—ä»Šæ—¥å¯¦æ”¶/æ·¨åˆ©');
      initToggle('faceTotalCard', 'btnToggleFaceTotal', 'ğŸŸï¸ é¡¯ç¤ºç¸½ç¥¨é¢/ç¥¨é¢(é¤˜)', 'ğŸŸï¸ éš±è—ç¸½ç¥¨é¢/ç¥¨é¢(é¤˜)');
      initToggle('noticeCard', 'btnToggleNotice', 'ğŸ”” é¡¯ç¤ºé€šçŸ¥', 'ğŸ”” éš±è—é€šçŸ¥');

      // ç›®å‰è³‡æ–™æœå°‹
      const currentSearch = document.getElementById('currentSearch');
      if (currentSearch) {
        currentSearch.addEventListener('input', () => {
          const q = (currentSearch.value || '').trim().toLowerCase();
          document.querySelectorAll('#currentCard .row[data-name]').forEach(row => {
            const name = row.getAttribute('data-name') || '';
            row.style.display = (!q || name.includes(q)) ? '' : 'none';
          });
        });
      }

      updateExpensePicked();
      updateBulkPicked();
    });

    function initToggle(cardId, btnId, showText, hideText) {
      const el = document.getElementById(cardId);
      const btn = document.getElementById(btnId);
      if (!el || !btn) return;
      const hidden = el.classList.contains('is-hidden');
      btn.textContent = hidden ? showText : hideText;
      btn.classList.toggle('active', !hidden);
    }

    // âœ… é€™ç‰ˆæ”¯æ´ 4 å€‹æŒ‰éˆ•ï¼ˆæ–‡å­—ï¼‹active éƒ½æœƒåˆ‡ï¼‰
    function toggleSection(id, btn) {
      const el = document.getElementById(id);
      if (!el) return;

      el.classList.toggle('is-hidden');
      const hidden = el.classList.contains('is-hidden');

      if (!btn) return;

      const map = {
        currentCard: ['ğŸ“Œ é¡¯ç¤ºç›®å‰è³‡æ–™', 'ğŸ“Œ éš±è—ç›®å‰è³‡æ–™'],
        expenseCard: ['ğŸ’¸ é¡¯ç¤ºä»Šæ—¥é–‹éŠ·', 'ğŸ’¸ éš±è—ä»Šæ—¥é–‹éŠ·'],
        todayCard: ['ğŸ’° é¡¯ç¤ºä»Šæ—¥å¯¦æ”¶/æ·¨åˆ©', 'ğŸ’° éš±è—ä»Šæ—¥å¯¦æ”¶/æ·¨åˆ©'],
        faceTotalCard: ['ğŸŸï¸ é¡¯ç¤ºç¸½ç¥¨é¢/ç¥¨é¢(é¤˜)', 'ğŸŸï¸ éš±è—ç¸½ç¥¨é¢/ç¥¨é¢(é¤˜)'],
        noticeCard: ['ğŸ”” é¡¯ç¤ºé€šçŸ¥', 'ğŸ”” éš±è—é€šçŸ¥'],
      };

      const t = map[id];
      if (t) btn.textContent = hidden ? t[0] : t[1];
      btn.classList.toggle('active', !hidden);
    }

    // ç›®å‰è³‡æ–™ï¼šå¤šç­†åˆªé™¤
    function toggleBulkMode() {
      const card = document.getElementById('currentCard');
      card.classList.toggle('bulk-mode');
      if (!card.classList.contains('bulk-mode')) {
        document.querySelectorAll('input[name="record_ids"]').forEach(cb => cb.checked = false);
        const all = document.getElementById('bulkSelectAll');
        if (all) all.checked = false;
        updateBulkPicked();
      }
    }

    function toggleSelectAll(master) {
      document.querySelectorAll('input[name="record_ids"]').forEach(cb => {
        cb.checked = master.checked;
      });
      updateBulkPicked();
    }

    function updateBulkPicked() {
      const n = document.querySelectorAll('input[name="record_ids"]:checked').length;
      const el = document.getElementById('bulkPicked');
      if (el) el.textContent = `å·²å‹¾é¸ ${n} ç­†`;
    }

    function confirmBulkDelete() {
      const n = document.querySelectorAll('input[name="record_ids"]:checked').length;
      if (n === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è³‡æ–™'); return false; }
      return confirm(`ç¢ºå®šè¦åˆªé™¤ ${n} ç­†è³‡æ–™å—ï¼Ÿ`);
    }

    // ä»Šæ—¥é–‹éŠ·ï¼šå…¨é¸/åˆªé™¤æç¤º
    function toggleExpenseAll(master) {
      document.querySelectorAll('#expenseCard input[name="expense_ids"]').forEach(cb => {
        cb.checked = master.checked;
      });
      updateExpensePicked();
    }

    function updateExpensePicked() {
      const n = document.querySelectorAll('#expenseCard input[name="expense_ids"]:checked').length;
      const el = document.getElementById('expensePicked');
      if (el) el.textContent = `å·²å‹¾é¸ ${n} ç­†`;
    }

    function confirmExpenseBulk() {
      const n = document.querySelectorAll('#expenseCard input[name="expense_ids"]:checked').length;
      if (n === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é–‹éŠ·'); return false; }
      return confirm(`ç¢ºå®šè¦åˆªé™¤ ${n} ç­†é–‹éŠ·å—ï¼Ÿ`);
    }


    // æ”¶è²»èªªæ˜ï¼šç¸®å°/å±•é–‹ï¼ˆæœªé–‹é€šæ‰æœƒæ¸²æŸ“ï¼‰
    function togglePricing() {
      const body = document.getElementById('pricingBody');
      const btn = document.getElementById('btnTogglePricing');
      if (!body || !btn) return;
      body.classList.toggle('is-hidden');
      const hidden = body.classList.contains('is-hidden');
      btn.textContent = hidden ? 'å±•é–‹' : 'ç¸®å°';
    }

    if (window.innerWidth < 640) {
      document.querySelectorAll('.seg-btn.active')
        .forEach(b => b.classList.remove('active'));
    }

  </script>
  <div class="card" style="margin-top:24px;">
    <p style="margin:0;">
      æœ¬ç³»çµ±ç‚ºå€‹äººé–‹ç™¼ç¶­è­·ã€‚<br>
      å¦‚æœ‰ <b>App</b> æˆ– <b>ç¶²é ç³»çµ±</b> è£½ä½œéœ€æ±‚ï¼Œæ­¡è¿è¯ç¹«æˆ‘ã€‚
    </p>
    <p style="margin-top:8px;">
      ğŸ“© LINEï¼š<b>@826ynmlh</b>
    </p>
  </div>

</body>

</html>