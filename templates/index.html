<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åˆ†æœŸè¨˜å¸³</title>
  <link rel="stylesheet" href="/static/style.css?v=1002">

  <style>
    /* é€šçŸ¥å€ï¼šæ¯å€æœ€å¤šé¡¯ç¤ºç´„ 5 ç­†ï¼Œè¶…éå°±æ²å‹• */
    .notice-list {
      max-height: 210px;
      /* ç´„ 5 ç­† */
      overflow-y: auto;
      padding-right: 6px;
    }

    .notice-list li {
      margin-bottom: 8px;
    }


    /* ç›®å‰è³‡æ–™ï¼šå¤šç­†åˆªé™¤æ¨¡å¼ */
    #bulkBar {
      display: none;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .bulkBox {
      display: none;
      padding: 10px 8px 0 0;
    }

    .bulk-mode #bulkBar {
      display: flex;
    }

    .bulk-mode .bulkBox {
      display: block;
    }
  </style>

</head>

<body>
  <div class="container">
    <h1>åˆ†æœŸè¨˜å¸³</h1>

    {% if paid_msg %}
    <div class="card">
      <p><b>{{ paid_msg }}</b></p>
    </div>
    {% endif %}

    {% if not user %}
    <div class="card">
      <h2>ç™»å…¥</h2>
      <form method="post" action="/login" class="form-grid">
        <label>å¸³è™Ÿ
          <input type="text" name="username" required>
        </label>
        <label>å¯†ç¢¼
          <input type="password" name="password" required>
        </label>
        <button type="submit" class="btn primary">ç™»å…¥</button>
      </form>
    </div>

    <div class="card">
      <h2>è¨»å†Š</h2>
      <form method="post" action="/register" class="form-grid">
        <label>å¸³è™Ÿ
          <input type="text" name="username" required>
        </label>
        <label>å¯†ç¢¼
          <input type="password" name="password" required>
        </label>
        <button type="submit" class="btn primary">è¨»å†Šä¸¦ç™»å…¥</button>
      </form>
    </div>

    {% else %}

    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
      <div>ç›®å‰ç™»å…¥ï¼š<b>{{ user.username }}</b></div>
      <form method="post" action="/logout" style="margin:0;">
        <button class="btn">ç™»å‡º</button>
      </form>
    </div>

    <div class="layout">

      <!-- å·¦é‚Šï¼šåŠŸèƒ½ -->
      <div class="main">

        <!-- âœ… åŠŸèƒ½ï¼šæ–°å¢ï¼ˆè·³é ï¼‰ -->
        <div class="card" style="text-align:center;">
          <h2>åŠŸèƒ½</h2>
          <a class="btn primary" href="/add-page">ï¼‹ æ–°å¢è³‡æ–™</a>
          <a class="btn" href="/expense-page" style="margin-left:10px;">ï¼‹ æ–°å¢é–‹éŠ·</a>
          <a class="btn" href="/history" style="margin-left:10px;">ğŸ“„ æ­·å²ç¹³æ¬¾</a>
        </div>
        <div class="card" style="text-align:center;">
          <div class="seg">
            <button type="button" class="seg-btn" id="btnToggleCurrent" onclick="toggleSection('currentCard', this)">
              ğŸ“Œ é¡¯ç¤ºç›®å‰è³‡æ–™
            </button>

            <button type="button" class="seg-btn" id="btnToggleExpense" onclick="toggleSection('expenseCard', this)">
              ğŸ’¸ é¡¯ç¤ºä»Šæ—¥é–‹éŠ·
            </button>
          </div>
        </div>



        <!-- âœ… ç›®å‰è³‡æ–™ -->
        <div class="card is-hidden" id="currentCard">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <h2 style="margin:0;">ç›®å‰è³‡æ–™</h2>
            <button type="button" class="btn danger" onclick="toggleBulkMode()">åˆªé™¤å¤šç­†</button>
          </div>
          {% if rows|length == 0 %}
          <p class="muted">ç›®å‰æ²’æœ‰è³‡æ–™</p>
          {% else %}
          <form id="bulkForm" action="/delete-multiple" method="post" style="margin:0;">
            <div id="bulkBar">
              <label style="display:flex; align-items:center; gap:6px;">
                <input id="bulkSelectAll" type="checkbox" onclick="toggleSelectAll(this)"> å…¨é¸
              </label>
              <button type="submit" class="btn danger" onclick="return confirmBulkDelete();">
                ç¢ºèªåˆªé™¤å‹¾é¸
              </button>
            </div>
          </form>

          <div class="list" style="max-height: 420px; overflow-y: auto; padding-right: 6px;">

            {% set sorted_rows = rows|sort(attribute='interval_days') %}
            {% set ns = namespace(last_interval=None) %}

            {% for r in sorted_rows %}
            {% if ns.last_interval != r.interval_days %}
            {% set ns.last_interval = r.interval_days %}
            <div class="meta" style="margin:10px 0 6px; font-weight:700;">
              âœ… {{ r.interval_days }} å¤©æ”¶æ¬¾
            </div>
            {% endif %}

            <div class="row">
              <div class="bulkBox">
                <input type="checkbox" name="record_ids" value="{{ r.id }}" form="bulkForm">
              </div>
              <div class="row-main">
                <div class="title">{{ r.name }}</div>
                <div class="meta">
                  {% set paid_sum = (r.paid_sum if r.paid_sum is defined else (r.paid_count * r.amount)) %}
                  {% set face_left = (r.face_value - paid_sum) %}
                  {% set spend_left = (r.total_amount - paid_sum) %}
                  {% set periods_left = (r.periods - r.paid_count) %}

                  å»ºç«‹æ—¥ï¼š{{ r.created_date }}

                  ï½œ ç¥¨é¢ {{ r.face_value }}/é¤˜
                  {% if face_left < 0 %} <span style="color:#dc2626; font-weight:700;">{{ face_left }}</span>
                    {% else %}
                    {{ face_left }}
                    {% endif %}

                    ï½œ æ”¯å‡º {{ r.total_amount }}/é¤˜
                    {% if spend_left < 0 %} <span style="color:#dc2626; font-weight:700;">{{ spend_left }}</span>
                      {% else %}
                      {{ spend_left }}
                      {% endif %}

                      ï½œ {{ r.periods }} æœŸ/é¤˜ {{ periods_left if periods_left > 0 else 0 }} æœŸ
                      ï½œ æ¯æœŸ {{ r.amount }}
                </div>


                <div class="notice">
                  é€±æœŸï¼šæ¯ {{ r.interval_days }} å¤©ä¸€æ¬¡
                  {% if r.finished %}
                  <!-- å·²çµæ¸…ä¸é¡¯ç¤º -->
                  {% elif r.days_left == 0 %}
                  ï½œ <b>ğŸ”” ä»Šå¤©è¦ç¹³æ¬¾</b>
                  {% elif r.days_left > 0 %}
                  ï½œ é‚„æœ‰ <b>{{ r.days_left }}å¤©</b>
                  {% else %}
                  ï½œ <b>å·²é€¾æœŸ {{ -r.days_left }}å¤©</b>
                  {% endif %}
                </div>
              </div>

              <div class="row-actions">
                {% if r.finished %}
                <p style="color: green; font-weight: bold;">âœ… å·²çµæ¸…</p>

                {% elif paid_id and r.id == paid_id %}
                <p style="color: #0a7; font-weight: bold;">âœ… ç¹³æ¬¾å®Œæˆ</p>

                {% elif r.is_due_today %}
                <!-- å·¦å´å¡ç‰‡ä¸é¡¯ç¤ºç¹³æ¬¾æŒ‰éˆ•ï¼ˆåªé¡¯ç¤ºæé†’ï¼‰ -->
                <p style="color: #f59e0b; font-weight: bold;">ğŸ”” ä»Šå¤©è¦ç¹³æ¬¾</p>

                {% elif r.is_overdue %}
                <!-- å·¦å´å¡ç‰‡ä¸é¡¯ç¤ºè£œç¹³æŒ‰éˆ•ï¼ˆåªé¡¯ç¤ºæé†’ï¼‰ -->
                <p style="color: red; font-weight: bold;">â— æœªå®Œæˆç¹³æ¬¾</p>
                <p style="color: gray; margin: 6px 0 0;">è«‹åˆ°å³å´é€šçŸ¥å€è£œç¹³</p>

                {% else %}
                <p style="color: gray;">å°šæœªåˆ°ç¹³æ¬¾æ—¥</p>
                {% endif %}

                {% if not r.finished %}
                <form action="/settle/{{ r.id }}" method="post" style="display:flex; gap:6px; align-items:center;">
                  <input type="number" name="amount" min="1" placeholder="çµæ¸…é‡‘é¡" style="width:90px; padding:6px;"
                    required>
                  <button class="btn primary" type="submit">å·²çµæ¸…</button>
                </form>
                {% endif %}

                <a class="btn" href="/edit/{{ r.id }}">ç·¨è¼¯</a>

                <form method="post" action="/delete/{{ r.id }}" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ');">
                  <button class="btn danger" type="submit">åˆªé™¤</button>
                </form>

              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>



      </div>

      <!-- å³é‚Šï¼šé€šçŸ¥ -->
      <div class="side">


        <div style="display:flex; gap:14px; align-items:stretch;">
          <div class="card" style="flex:1; margin-bottom:14px;">
            <h2>ä»Šæ—¥å¯¦æ”¶</h2>
            <p style="font-size: 22px; margin: 0;"><b>{{ today_total }}</b></p>
          </div>

          <div class="card" style="flex:1; margin-bottom:14px;">
            <h2>ä»Šæ—¥æ·¨æ”¶</h2>
            <p style="font-size: 22px; margin: 0;"><b>{{ today_net }}</b></p>
          </div>

          <div class="card" style="flex:1; margin-bottom:14px;">
            <h2>ç¸½ç¥¨é¢</h2>
            <p style="font-size: 22px; margin: 0;"><b>{{ total_face_value }}</b></p>
          </div>
        </div>


        <div class="card is-hidden" id="expenseCard">
          <h2>ä»Šæ—¥é–‹éŠ·</h2>
          <p style="font-size: 22px; margin: 0;"><b>{{ today_expense_total }}</b></p>

          {% if today_expenses|length == 0 %}
          <p class="muted" style="margin-top:10px;">ä»Šå¤©å°šæœªæ–°å¢é–‹éŠ·</p>
          {% else %}
          <ul class="notice-list" style="margin-top:10px;">
            {% for e in today_expenses %}
            <li>
              â€¢ {{ e.item }}ï¼š{{ e.amount }}
              <a class="btn" href="/expense/edit/{{ e.id }}" style="margin-left:8px;">
                ç·¨è¼¯
              </a>
            </li>
            {% endfor %}

          </ul>
          {% endif %}
        </div>


        <div class="card">
          <h2>é€šçŸ¥</h2>

          <h3>ä»Šæ—¥æ”¶æ¬¾</h3>
          {% if today_due_records|length == 0 %}
          <p>ä»Šå¤©æ²’æœ‰åˆ°æœŸçš„ç¹³æ¬¾</p>
          {% else %}
          <ul class="notice-list">
            {% for r in today_due_records %}
            <li>
              ğŸ”” {{ r.name }}ï¼ˆç¬¬ {{ r.paid_count + 1 }} / {{ r.periods }} æœŸï¼Œ{{ r.amount }} å…ƒï¼‰
              <form action="/pay/{{ r.id }}" method="post" style="display:inline;">
                <button class="btn" type="submit">å·²ç¹³æ¬¾</button>
              </form>
            </li>
            {% endfor %}
          </ul>
          {% endif %}

          <h3>æ˜æ—¥æ”¶æ¬¾</h3>
          {% set ns = namespace(has_tomorrow=false) %}
          <ul class="notice-list">
            {% for r in rows %}
            {% if r.days_left == 1 and (r.paid_count < r.periods) %} {% set ns.has_tomorrow=true %} <li>â³ {{ r.name
              }}ï¼ˆæ˜å¤©åˆ°æœŸï¼Œç¬¬ {{ r.paid_count + 1 }} / {{ r.periods }} æœŸï¼Œ{{ r.amount }} å…ƒï¼‰</li>
              {% endif %}
              {% endfor %}
          </ul>
          {% if not ns.has_tomorrow %}
          <p>æ˜å¤©æ²’æœ‰åˆ°æœŸçš„æ”¶æ¬¾</p>
          {% endif %}

          <h3>é€¾æœŸ</h3>
          {% if overdue_records|length == 0 %}
          <p>ç›®å‰æ²’æœ‰é€¾æœŸ</p>
          {% else %}
          <ul class="notice-list">
            {% for r in overdue_records %}
            <li>
              {% set interval = r.interval_days if r.interval_days and r.interval_days > 0 else 1 %}
              {% set delta = -r.days_left %}

              {# å…ˆç®—é€¾æœŸå¹¾æœŸï¼ˆåŸå§‹ï¼‰ #}
              {% set overdue_raw = ((delta - 1) // interval + 1) if delta > 0 else 0 %}

              {# å‰©é¤˜æœŸæ•¸ = ç¸½æœŸæ•¸ - å·²ç¹³æœŸæ•¸ï¼ˆä¸‹é™ 0ï¼‰ #}
              {% set remaining = (r.periods - r.paid_count) %}
              {% if remaining < 0 %}{% set remaining=0 %}{% endif %} {# é€¾æœŸæœŸæ•¸ä¸Šé™ï¼šä¸èƒ½è¶…éå‰©é¤˜æœŸæ•¸ #} {% set
                overdue_periods=overdue_raw if overdue_raw < remaining else remaining %} â— {{ r.name }}ï¼ˆé€¾æœŸ {{
                overdue_periods }} æœŸï¼‰ <form action="/pay/{{ r.id }}" method="post"
                style="display:inline-flex; align-items:center; gap:6px;">
                (
                <input type="number" name="periods" min="1" style="width:60px; padding:4px;" placeholder="æœŸæ•¸" required>
                )
                <button class="btn" type="submit">è£œç¹³</button>
                </form>
            </li>


            {% endfor %}
          </ul>
          {% endif %}
        </div>

      </div>


    </div>

    <!-- å–æ¶ˆå½ˆè·³é€šçŸ¥è¦–çª—ï¼ˆä¸å† alertï¼‰ -->

    {% endif %}
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      initToggle('currentCard', 'btnToggleCurrent', 'ğŸ“Œ é¡¯ç¤ºç›®å‰è³‡æ–™', 'ğŸ“Œ éš±è—ç›®å‰è³‡æ–™');
      initToggle('expenseCard', 'btnToggleExpense', 'ğŸ’¸ é¡¯ç¤ºä»Šæ—¥é–‹éŠ·', 'ğŸ’¸ éš±è—ä»Šæ—¥é–‹éŠ·');
    });

    function initToggle(cardId, btnId, showText, hideText) {
      const el = document.getElementById(cardId);
      const btn = document.getElementById(btnId);
      if (!el || !btn) return;
      const hidden = el.classList.contains('is-hidden');
      btn.textContent = hidden ? showText : hideText;
      btn.classList.toggle('active', !hidden);
    }

    function toggleSection(id, btn) {
      const el = document.getElementById(id);
      if (!el) return;

      el.classList.toggle('is-hidden');
      const hidden = el.classList.contains('is-hidden');

      if (btn) {
        if (id === 'currentCard') {
          btn.textContent = hidden ? 'ğŸ“Œ é¡¯ç¤ºç›®å‰è³‡æ–™' : 'ğŸ“Œ éš±è—ç›®å‰è³‡æ–™';
        } else if (id === 'expenseCard') {
          btn.textContent = hidden ? 'ğŸ’¸ é¡¯ç¤ºä»Šæ—¥é–‹éŠ·' : 'ğŸ’¸ éš±è—ä»Šæ—¥é–‹éŠ·';
        }
        btn.classList.toggle('active', !hidden);
      }
    }

    function toggleBulkMode() {
      const card = document.getElementById('currentCard');
      card.classList.toggle('bulk-mode');
      if (!card.classList.contains('bulk-mode')) {
        document.querySelectorAll('input[name="record_ids"]').forEach(cb => cb.checked = false);
        const all = document.getElementById('bulkSelectAll');
        if (all) all.checked = false;
      }
    }
    function toggleSelectAll(master) {
      document.querySelectorAll('input[name="record_ids"]').forEach(cb => {
        cb.checked = master.checked;
      });
    }
    function confirmBulkDelete() {
      const n = document.querySelectorAll('input[name="record_ids"]:checked').length;
      if (n === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è³‡æ–™'); return false; }
      return confirm(`ç¢ºå®šè¦åˆªé™¤ ${n} ç­†è³‡æ–™å—ï¼Ÿ`);
    }
  </script>




</body>

</html>